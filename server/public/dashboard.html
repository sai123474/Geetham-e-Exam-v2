<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard - Geetham e-Exam</title>
    <link rel="icon" type="image/jpeg" href="/geetham.jpg" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg:#f8f9fa; --card:#fff; --text:#1f2937; --muted:#6b7280; --brand:#0056b3;
            --brand-2:#007bff; --ok:#28a745; --warn:#f59e0b; --danger:#dc3545; --info:#17a2b8;
            --border:#e5e7eb; --shadow:0 4px 12px rgba(0,0,0,.08);
        }
        body{font-family:Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:16px;line-height:1.5;}
        .container{max-width:1400px;margin:auto;padding:24px;border-radius:12px;}
        .header{text-align:center;margin-bottom:16px;}
        .header img{max-height:64px;}
        .toolbar{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px;justify-content:space-between;align-items:center;padding:15px;background:var(--card);border-radius:8px;box-shadow:var(--shadow);}
        select,input[type="text"]{padding:8px 12px;font-size:16px;border-radius:8px;border:1px solid var(--border);}
        button{padding:8px 12px;border:none;border-radius:8px;color:white;cursor:pointer;}
        .charts-container {display:grid;grid-template-columns:repeat(auto-fill, minmax(400px, 1fr));gap:20px;margin-bottom:20px;}
        .chart-card {background:var(--card);border-radius:8px;padding:15px;box-shadow:var(--shadow);}
        .stats-grid {display:grid;grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));gap:15px;margin-bottom:20px;}
        .stat-card {background:var(--card);border-radius:8px;padding:15px;box-shadow:var(--shadow);text-align:center;}
        .stat-value {font-size:24px;font-weight:bold;color:var(--brand);margin:10px 0;}
        .stat-label {color:var(--muted);font-size:14px;}
        .table-wrap{border:1px solid var(--border);border-radius:8px;overflow:auto;margin-top:20px;background:var(--card);box-shadow:var(--shadow);}
        table{width:100%;border-collapse:collapse;}
        thead th{position:sticky;top:0;background:var(--brand);color:#fff;padding:10px;cursor:pointer;text-align:center;}
        tbody td{padding:10px;border-top:1px solid var(--border);text-align:center;}
        #auth-screen { max-width: 400px; margin: 100px auto; padding: 40px; text-align: center; background: var(--card); border-radius: 12px; box-shadow: var(--shadow); }
        .score-low{background-color: #ffebee; color: var(--danger);}
        .score-medium{background-color: #fff8e1; color: var(--warn);}
        .score-high{background-color: #e8f5e9; color: var(--ok);}
        #map { height: 400px; margin-top: 20px; border-radius: 12px; box-shadow: var(--shadow); }
    </style>
</head>
<body>

<div id="auth-screen">
    <img src="/geetham.jpg" alt="Geetham Logo" style="max-height:64px; margin-bottom:15px;">
    <h2>Dashboard Authentication</h2>
    <input type="password" id="dashboard-password" placeholder="Enter Admin Password">
    <button id="login-btn" style="width:100%; background:var(--ok);">Login</button>
</div>

<div class="container" id="main-content" style="display:none;">
    <div class="header">
        <img src="/geetham.jpg" alt="Geetham Logo">
        <h1>Results & Analytics Dashboard</h1>
    </div>
    <div class="toolbar">
        <div>
            <label for="quizFilter">Exam:</label>
            <select id="quizFilter"><option value="all">All Exams</option></select>
            <input id="search" type="text" placeholder="Search by Name or Mobile…">
        </div>
        <div>
            <button id="refreshBtn" style="background:var(--ok);">⟳ Refresh</button>
        </div>
    </div>
    
    <div class="stats-grid" id="stats-grid"></div>
    <div class="charts-container">
        <div class="chart-card"><h3>Score Distribution</h3><canvas id="scoreDistChart"></canvas></div>
        <div class="chart-card"><h3>Subject Performance</h3><canvas id="subjectChart"></canvas></div>
    </div>
    
    <div class="table-wrap">
        <table id="results-table">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>
    
    <div id="map"></div>
</div>

<script>
    (function(){
        let allResults = [], allQuizzes = [], filteredResults = [], dynamicSubjects = [], sortKey = 'rank', sortDir = 'asc';
        let scoreDistChart, subjectChart;

        const mainContent = document.getElementById('main-content');
        const authScreen = document.getElementById('auth-screen');
        const loginBtn = document.getElementById('login-btn');
        const passwordInput = document.getElementById('dashboard-password');

        async function loginDashboard() {
            const password = passwordInput.value;
            if (!password) return alert('Password is required.');
            
            try {
                const response = await fetch('/login-dashboard', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                if (!response.ok) throw new Error('Login failed');
                const { accessToken } = await response.json();
                localStorage.setItem('dashboardToken', accessToken);
                
                authScreen.style.display = 'none';
                mainContent.style.display = 'block';
                await initializeDashboard();

            } catch (error) {
                alert('Incorrect password or server error.');
            }
        }

        function checkAuth() {
            if (localStorage.getItem('dashboardToken')) {
                authScreen.style.display = 'none';
                mainContent.style.display = 'block';
                initializeDashboard();
            } else {
                authScreen.style.display = 'block';
            }
        }

        loginBtn.onclick = loginDashboard;
        passwordInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') loginDashboard();
        });

        function calculateMaxScore(quiz) {
            if (!quiz?.subjects) return 100;
            let totalMax = 0;
            Object.values(quiz.subjects).forEach(subjectQuestions => {
                subjectQuestions.forEach(q => {
                    totalMax += Number((quiz.marksMode === 'custom' ? q.correctMarks : quiz.correctMarks) || 1);
                });
            });
            return totalMax > 0 ? totalMax : 100;
        }

        function computeRanks(arr) {
            const sorted = [...arr].sort((a,b) => b.finalTotalScore - a.finalTotalScore);
            const scoreToRank = new Map();
            let rank = 1;
            sorted.forEach((item, index) => {
                if(!scoreToRank.has(item.finalTotalScore)) {
                    scoreToRank.set(item.finalTotalScore, index + 1);
                }
            });
            return arr.map(it => ({...it, rank: scoreToRank.get(it.finalTotalScore)}));
        }

        function initCharts() {
            const scoreCtx = document.getElementById('scoreDistChart').getContext('2d');
            scoreDistChart = new Chart(scoreCtx, {
                type: 'bar', data: { labels: ['0-20%', '21-40%', '41-60%', '61-80%', '81-100%'], datasets: [{ label: '# of Students', data: [], backgroundColor: '#007bff' }] }
            });

            const subjectCtx = document.getElementById('subjectChart').getContext('2d');
            subjectChart = new Chart(subjectCtx, {
                type: 'radar', data: { labels: [], datasets: [{ label: 'Average Score %', data: [], backgroundColor: 'rgba(0, 123, 255, 0.2)', borderColor: '#007bff' }] },
                options: { scales: { r: { beginAtZero: true, max: 100 } } }
            });
        }

        function applyFiltersAndRender() {
            const quizId = document.getElementById('quizFilter').value;
            const searchTerm = document.getElementById('search').value.toLowerCase();

            const rankedResults = computeRanks(allResults);

            filteredResults = rankedResults.filter(r => {
                const quiz = allQuizzes.find(q => q.id === r.quizId);
                const matchQuiz = quizId === 'all' || r.quizId.toString() === quizId;
                const matchSearch = !searchTerm || r.studentName?.toLowerCase().includes(searchTerm) || r.mobile?.includes(searchTerm);
                return matchQuiz && matchSearch;
            });
            
            filteredResults.sort((a,b) => {
                let valA = a[sortKey], valB = b[sortKey];
                if(sortKey.startsWith('subjectScores.')) {
                    const sub = sortKey.split('.')[1];
                    valA = a.subjectScores[sub] || 0;
                    valB = b.subjectScores[sub] || 0;
                }
                if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
                if (valA < valB) return sortDir === 'asc' ? -1 : 1;
                if (valA > valB) return sortDir === 'asc' ? 1 : -1;
                return a.rank - b.rank; // Secondary sort by rank
            });
            
            updateStats();
            updateCharts();
            updateTable();
            updateMap();
        }

        function updateStats() {
            const statsGrid = document.getElementById('stats-grid');
            if (filteredResults.length === 0) {
                statsGrid.innerHTML = '<div class="stat-card"><p>No data for selected filters.</p></div>';
                return;
            }
            const totalStudents = filteredResults.length;
            const totalWarnings = filteredResults.reduce((sum, r) => sum + (r.warnings || 0), 0);
            const avgWarnings = totalStudents > 0 ? (totalWarnings / totalStudents) : 0;
            const passCount = filteredResults.filter(r => (r.finalTotalScore / r.totalMaxScore) * 100 >= 40).length;
            const passRate = totalStudents > 0 ? (passCount / totalStudents) * 100 : 0;
            const avgScore = totalStudents > 0 ? (filteredResults.reduce((sum, r) => sum + (r.finalTotalScore / r.totalMaxScore), 0) / totalStudents) * 100 : 0;

            statsGrid.innerHTML = `
                <div class="stat-card"><div class="stat-label">Total Submissions</div><div class="stat-value">${totalStudents}</div></div>
                <div class="stat-card"><div class="stat-label">Average Score</div><div class="stat-value">${avgScore.toFixed(1)}%</div></div>
                <div class="stat-card"><div class="stat-label">Pass Rate (>=40%)</div><div class="stat-value">${passRate.toFixed(1)}%</div></div>
                <div class="stat-card"><div class="stat-label">Avg. Warnings</div><div class="stat-value">${avgWarnings.toFixed(1)}</div></div>
            `;
        }
        
        function updateCharts() {
            if (!scoreDistChart || filteredResults.length === 0) return;
            // Score Distribution
            const scoreRanges = [0, 0, 0, 0, 0];
            filteredResults.forEach(r => {
                const scorePercent = (r.finalTotalScore / r.totalMaxScore) * 100;
                scoreRanges[Math.min(Math.floor(scorePercent / 20.01), 4)]++;
            });
            scoreDistChart.data.datasets[0].data = scoreRanges;
            scoreDistChart.update();
            
            // Subject Performance
            const subjectData = {};
            filteredResults.forEach(r => {
                Object.entries(r.subjectScores).forEach(([sub, score]) => {
                    if (!subjectData[sub]) subjectData[sub] = { total: 0, count: 0, max: 0 };
                    const quiz = allQuizzes.find(q => q.id === r.quizId);
                    const subMax = quiz.subjects[sub]?.reduce((acc, q) => acc + ((quiz.marksMode === 'custom' ? q.correctMarks : quiz.correctMarks) || 1), 0) || 1;
                    subjectData[sub].total += (score / subMax) * 100;
                    subjectData[sub].count++;
                });
            });
            const labels = Object.keys(subjectData).sort();
            subjectChart.data.labels = labels;
            subjectChart.data.datasets[0].data = labels.map(sub => subjectData[sub].total / subjectData[sub].count);
            subjectChart.update();
        }

        function updateTable() {
            const thead = document.querySelector('#results-table thead');
            const tbody = document.querySelector('#results-table tbody');
            const subjectSet = new Set();
            allResults.forEach(res => Object.keys(res.subjectScores).forEach(sub => subjectSet.add(sub)));
            dynamicSubjects = Array.from(subjectSet).sort();

            let headerHTML = `<tr><th data-key="rank">Rank</th><th data-key="studentName">Name</th><th data-key="mobile">Mobile</th><th data-key="finalTotalScore">Final Score (%)</th>`;
            dynamicSubjects.forEach(sub => headerHTML += `<th data-key="subjectScores.${sub}">${sub}</th>`);
            headerHTML += `<th data-key="warnings">Warnings</th></tr>`;
            thead.innerHTML = headerHTML;

            if (filteredResults.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${4 + dynamicSubjects.length}">No results found.</td></tr>`;
                return;
            }
            tbody.innerHTML = filteredResults.map(res => {
                const scorePercent = (res.finalTotalScore / res.totalMaxScore) * 100;
                const scoreClass = scorePercent >= 75 ? 'score-high' : scorePercent >= 40 ? 'score-medium' : 'score-low';
                let subjectCells = dynamicSubjects.map(sub => `<td>${(res.subjectScores[sub] || 0).toFixed(2)}</td>`).join('');
                return `<tr>
                    <td><b>${res.rank}</b></td><td>${res.studentName}</td><td>${res.mobile}</td>
                    <td class="${scoreClass}">${scorePercent.toFixed(1)}%</td>
                    ${subjectCells}
                    <td class="${res.warnings >= 3 ? 'score-low' : ''}">${res.warnings}</td>
                </tr>`;
            }).join('');

            thead.querySelectorAll('th[data-key]').forEach(th => th.onclick = () => {
                const key = th.dataset.key;
                sortDir = (sortKey === key && sortDir === 'asc') ? 'desc' : 'asc';
                sortKey = key;
                applyFiltersAndRender();
            });
        }
        
        function updateMap() {
            if(window.mapInstance) window.mapInstance.remove();
            const mapData = filteredResults.filter(r => r.location?.lat && r.location?.lon);
            const mapEl = document.getElementById('map');
            if (mapData.length === 0) {
                mapEl.innerHTML = "<p style='text-align:center; padding:20px;'>No accurate location data available.</p>";
                return;
            }
            mapEl.innerHTML = "";
            window.mapInstance = L.map('map').setView([20.5937, 78.9629], 4); // Center of India
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(window.mapInstance);
            mapData.forEach(r => L.marker([r.location.lat, r.location.lon]).addTo(window.mapInstance)
                .bindPopup(`<b>${r.studentName}</b><br>Score: ${(r.finalTotalScore / r.totalMaxScore * 100).toFixed(1)}%`));
        }

        async function initializeDashboard() {
            try {
                const token = localStorage.getItem('dashboardToken');
                const headers = { 'Authorization': `Bearer ${token}` };
                const response = await fetch('/dashboard-data', { headers });
                
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('dashboardToken');
                        checkAuth();
                    }
                    throw new Error('Failed to fetch dashboard data');
                }
                
                const data = await response.json();
                allQuizzes = data.quizzes || [];
                const quizMap = new Map(allQuizzes.map(q => [q.id, { ...q, totalMaxScore: calculateMaxScore(q) }]));
                
                allResults = (data.results || []).map(r => {
                    const quiz = quizMap.get(r.quizId);
                    return {
                        ...r,
                        studentName: r.studentName || 'N/A',
                        mobile: r.mobile || 'N/A',
                        quizTitle: quiz ? quiz.title : (r.quizTitle || "Untitled"),
                        finalTotalScore: Number(r.totalScore || 0),
                        totalMaxScore: quiz ? quiz.totalMaxScore : 100
                    };
                });
                
                const quizFilter = document.getElementById('quizFilter');
                const uniqueQuizzes = allQuizzes.filter(q => allResults.some(r => r.quizId === q.id));
                quizFilter.innerHTML = '<option value="all">All Exams</option>' + uniqueQuizzes.map(q => `<option value="${q.id}">${q.title}</option>`).join('');
                
                initCharts();
                applyFiltersAndRender();
                
                quizFilter.onchange = applyFiltersAndRender;
                document.getElementById('search').oninput = applyFiltersAndRender;
                document.getElementById('refreshBtn').onclick = initializeDashboard;

            } catch (error) {
                console.error('Initialization Error:', error);
                alert('Failed to load dashboard. Please try refreshing or logging in again.');
            }
        }
        
        checkAuth();
    })();
</script>
</body>
</html>