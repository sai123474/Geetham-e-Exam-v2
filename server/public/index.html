<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Geetham e-Exam</title>
    <link rel="icon" type="image/jpeg" href="/geetham.jpg" />
    <meta name="description" content="Geetham e-Exam platform for online assessments" />
    <meta name="theme-color" content="#0056b3" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js"></script>
    <style>
        :root {
            --primary-color: #0056b3; --primary-light: #007bff; --success-color: #28a745;
            --warning-color: #ffc107; --danger-color: #dc3545; --text-color: #333;
            --text-light: #6c757d; --bg-color: #f0f2f5; --card-bg: #fff; --border-color: #ddd;
            --shadow: 0 2px 8px rgba(0,0,0,0.1); --border-radius: 8px; --focus-ring: 0 0 0 3px rgba(0,123,255,0.25);
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 10px;
            line-height: 1.5; font-size: 16px;
        }
        .main-container, #student-details-screen { display: none; }
        .main-container.active { display: flex; }
        #student-details-screen.active { display: block; }
        .exam-panel { flex-grow: 1; background: var(--card-bg); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .sidebar { width: 300px; margin-left: 20px; background: var(--card-bg); padding: 15px; border-radius: var(--border-radius); box-shadow: var(--shadow); align-self: flex-start; }
        h1, h2 { color: var(--primary-color); text-align: center; margin-top: 0.5em; margin-bottom: 0.5em; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid var(--border-color); border-radius: var(--border-radius); box-sizing: border-box; font-size: 16px; }
        input:focus, select:focus, button:focus { outline: none; box-shadow: var(--focus-ring); }
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        #timer { font-size: 20px; font-weight: bold; color: var(--danger-color); text-align: center; margin-bottom: 15px; }
        .subject-tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .subject-tab { padding: 10px 20px; cursor: pointer; font-weight: 600; border: none; background-color: var(--bg-color); color: var(--text-color); font-size: 16px; border-radius: 8px 8px 0 0; white-space: nowrap; transition: background-color 0.2s, color 0.2s; }
        .subject-tab.active { background-color: var(--primary-light); color: white; }
        .question-area { min-height: 300px; padding: 10px; border-radius: var(--border-radius); background-color: rgba(255, 255, 255, 0.5); }
        .option { display: block; margin: 10px 0; padding: 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius); cursor: pointer; transition: all 0.2s ease; }
        .option:hover { background-color: rgba(0, 123, 255, 0.05); border-color: var(--primary-light); }
        .option.selected { background-color: var(--primary-light); color: white; border-color: var(--primary-light); }
        .nav-buttons { margin-top: 20px; display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px; }
        button { background-color: var(--primary-light); color: white; padding: 12px 20px; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 16px; font-weight: 500; transition: background-color 0.2s, transform 0.1s; }
        button:hover { background-color: #0069d9; }
        button:disabled { background-color: var(--text-light); cursor: not-allowed; opacity: 0.7; }
        .palette-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 10px; }
        .palette-item { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; font-weight: bold; transition: transform 0.2s; }
        .status-not-answered { background-color: #f0f0f0; }
        .status-answered { background-color: var(--success-color); color: white; }
        .status-review { background-color: var(--warning-color); }
        #camera-wrapper { position: fixed; bottom: 10px; left: 10px; width: 160px; height: 120px; border: 2px solid var(--primary-color); border-radius: var(--border-radius); background: #000; overflow: hidden; display: none; z-index: 9998; resize: both; box-shadow: var(--shadow); }
        #camera-header { height: 22px; background: rgba(0,86,179,0.9); color: #fff; display: flex; align-items: center; justify-content: center; padding: 0 6px; cursor: move; font-size: 12px; }
        #camera-view { width: 100%; height: calc(100% - 22px); object-fit: cover; display: block; }
        .toast { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); padding: 15px 25px; border-radius: var(--border-radius); box-shadow: 0 4px 12px rgba(0,0,0,0.2); font-size: 16px; font-weight: bold; z-index: 100000; opacity: 0; transition: opacity 0.5s, top 0.5s; max-width: 90%; word-wrap: break-word; }
        .toast.show { top: 40px; opacity: 1; }
        .toast.warning { background-color: var(--danger-color); color: white; }
        .toast.success { background-color: var(--success-color); color: white; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; margin-right: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #fullscreen-warning { background: rgba(0,0,0,0.9) !important; }
        @media (max-width: 900px) {
            body { padding: 5px; }
            .main-container { flex-direction: column; }
            .sidebar { width: 100%; margin-left: 0; margin-top: 20px; box-sizing: border-box; }
            .nav-buttons { flex-direction: column; align-items: stretch; }
            .nav-buttons > div { display: flex; justify-content: space-between; margin-top: 10px; }
            .exam-panel, .sidebar { padding: 15px; }
        }
    </style>
</head>
<body>
    <div id="fullscreen-warning" style="display:none; flex-direction: column; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); color: white; z-index: 10000; text-align: center;">
        <h1>You Have Exited Full-Screen!</h1>
        <p>Please return to full-screen to continue the exam. The exam will be submitted if you fail to return.</p>
    </div>

    <div id="student-details-screen" class="active">
        <div style="max-width: 500px; margin: 50px auto; background: var(--card-bg); padding: 30px; border-radius: 8px; box-shadow: var(--shadow);">
            <div style="text-align: center; margin-bottom: 15px;">
                <img src="/geetham.jpg" alt="Geetham Institute Logo" style="max-height: 80px;">
            </div>
            <h1>Geetham e-Exam</h1>
            <div id="login-form">
                <h2>Enter Your Details</h2>
                <div id="quiz-selection-container"></div>
                <input type="text" id="student-name" placeholder="Enter your full name" required autocomplete="off">
                <input type="tel" id="student-mobile" placeholder="Enter your mobile number" required autocomplete="off">
                <button id="proceed-btn" style="width: 100%;"><span id="proceed-btn-text">Proceed</span><span id="proceed-loading" class="loading" style="display:none;"></span></button>
            </div>
        </div>
    </div>

    <div class="main-container" id="exam-screen">
        <div class="exam-panel">
            <h1 style="margin-top: 0;" id="exam-title-main"></h1>
            <div id="timer">00:00:00</div>
            <div class="subject-tabs"></div>
            <div id="question-area" class="question-area"></div>
            <div class="nav-buttons">
                <button onclick="markForReview()" aria-label="Mark question for review and go to next question">ðŸ”– Mark for Review & Next</button>
                <div>
                    <button onclick="goPrevious()" aria-label="Go to previous question">â—€ Previous</button>
                    <button onclick="clearResponse()" aria-label="Clear your answer">âœ– Clear</button>
                    <button onclick="saveAndNext()" aria-label="Save your answer and go to next question">â–¶ Save & Next</button>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="submit" onclick="confirmSubmit()" style="background-color: var(--danger-color);" aria-label="Submit your exam">âœ“ Submit Exam</button>
            </div>
        </div>
        <div class="sidebar">
            <h4>Question Palette</h4>
            <div id="question-palette" class="palette-grid"></div>
            <hr>
            <h4>Legend</h4>
            <div style="display:flex; align-items: center; margin-top: 10px;"><div class="palette-item status-answered"></div><span style="margin-left: 10px;">Answered</span></div>
            <div style="display:flex; align-items: center; margin-top: 10px;"><div class="palette-item status-review"></div><span style="margin-left: 10px;">Marked for Review</span></div>
            <div style="display:flex; align-items: center; margin-top: 10px;"><div class="palette-item status-not-answered"></div><span style="margin-left: 10px;">Not Answered</span></div>
        </div>
        <div id="camera-wrapper">
            <div id="camera-header"><span>Camera</span></div>
            <video id="camera-view" autoplay playsinline muted></video>
        </div>
    </div>

<script type="module">
    import { FaceLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js";

    // --- IMPORTANT: ADD YOUR BASE64 LOGO HERE ---
    const GEETHAM_LOGO_BASE64 = 'PASTE_YOUR_BASE64_LOGO_STRING_HERE';

    // --- GLOBAL STATE ---
    let allExams = [], currentExam = {}, currentSubject = "", currentQuestionIndex = 0;
    let userResponses = {}, studentDetails = {}, finalScores = {};
    let timerInterval, examInProgress = false, warningCount = 0;
    const maxWarnings = 3;
    let faceLandmarker;

    // --- PROCTORING STATE ---
    let multiFaceCounter = 0, noFaceCounter = 0, lookDownCounter = 0;
    const MULTI_FACE_THRESHOLD = 20;
    const NO_FACE_THRESHOLD = 30; 
    const LOOK_DOWN_THRESHOLD = 40; // Approx. 2 seconds of looking down

    // --- UI HELPER ---
    function showToast(message, type = 'warning') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 500);
        }, 4000);
    }

    // --- PERMISSIONS & STARTUP FLOW ---
    async function startCamera() {
        const video = document.getElementById('camera-view');
        if (!navigator.mediaDevices?.getUserMedia) throw new Error("Camera not supported.");
        const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 160, height: 120 } });
        video.srcObject = stream;
        document.getElementById('camera-wrapper').style.display = 'block';
        await new Promise(resolve => video.onloadedmetadata = resolve);
    }
    
    function startExamFlow(location) {
        studentDetails.location = location;
        document.getElementById('student-details-screen').classList.remove('active');
        document.getElementById('exam-screen').classList.add('active');
        initializeExam();
    }

    function requestLocationAndStart() {
        if (!navigator.geolocation) return alert("Geolocation is not supported by your browser. You cannot proceed.");
        
        showToast("Please grant location permission to start the exam.", "success");
        navigator.geolocation.getCurrentPosition(
            async (position) => {
                const location = { lat: position.coords.latitude, lon: position.coords.longitude };
                try {
                    await startCamera();
                    await document.documentElement.requestFullscreen();
                    showToast("Permissions granted! Starting exam...", "success");
                    setTimeout(() => startExamFlow(location), 1500);
                } catch (err) {
                    alert("Could not start. Please allow both Camera and Fullscreen permissions.");
                }
            },
            () => { alert("Location permission is REQUIRED to start the exam. Please enable it and try again."); }
        );
    }
    
    // --- PROCTORING LOGIC ---
    function handleWarning(message) {
        if (!examInProgress) return;
        warningCount++;
        showToast(`Warning ${warningCount}/${maxWarnings}: ${message}`, 'warning');
        if (warningCount >= maxWarnings) {
            setTimeout(() => {
                showToast(`Maximum warnings exceeded. Submitting exam automatically.`, 'warning');
                submitExam();
            }, 1000);
        }
    }

    async function setupProctoring() {
        try {
            const filesetResolver = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm");
            faceLandmarker = await FaceLandmarker.createFromOptions(filesetResolver, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`,
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                outputFaceBlendshapes: true, // Enable blendshapes for head pose
                numFaces: 2
            });
            predictWebcam();
        } catch(e) { console.error("Failed to load proctoring model.", e); }
    }
    
    function predictWebcam() {
        if (!examInProgress || !faceLandmarker) return;
        const video = document.getElementById('camera-view');
        if (video.readyState >= 2) {
            const results = faceLandmarker.detectForVideo(video, performance.now());
            
            if (results.faceLandmarks && results.faceLandmarks.length > 1) {
                multiFaceCounter++;
                if (multiFaceCounter >= MULTI_FACE_THRESHOLD) {
                    handleWarning("Multiple faces detected.");
                    multiFaceCounter = 0;
                }
            } else { multiFaceCounter = 0; }
            
            if (!results.faceLandmarks || results.faceLandmarks.length === 0) {
                noFaceCounter++;
                if (noFaceCounter >= NO_FACE_THRESHOLD) {
                    handleWarning("No face detected. Please stay in front of the camera.");
                    noFaceCounter = 0;
                }
            } else {
                noFaceCounter = 0;
                
                // Head pose detection (looking down)
                const blendshapes = results.faceBlendshapes[0]?.categories || [];
                const lookDownScore = (blendshapes.find(s => s.categoryName === 'eyeLookDownLeft')?.score || 0) + 
                                      (blendshapes.find(s => s.categoryName === 'eyeLookDownRight')?.score || 0);

                if (lookDownScore > 0.8) { // Threshold for looking down
                    lookDownCounter++;
                    if (lookDownCounter >= LOOK_DOWN_THRESHOLD) {
                        handleWarning("Please look at the screen. Looking down is not permitted.");
                        lookDownCounter = 0;
                    }
                } else { lookDownCounter = 0; }
            }
        }
        window.requestAnimationFrame(predictWebcam);
    }
    
    function setupProctoringListeners() {
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement && examInProgress) {
                handleWarning("You have exited full-screen.");
                document.getElementById('fullscreen-warning').style.display = 'flex';
            } else {
                document.getElementById('fullscreen-warning').style.display = 'none';
            }
        });
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && examInProgress) handleWarning("You have switched tabs.");
        });
        window.addEventListener('blur', () => {
            if (examInProgress) handleWarning("Browser window lost focus.");
        });
        document.addEventListener('contextmenu', (e) => {
            if (examInProgress) { e.preventDefault(); handleWarning("Right-clicking is disabled."); }
        });
        document.addEventListener('keydown', (e) => {
            if (!examInProgress) return;
            if ((e.ctrlKey && ['c', 'v', 'p'].includes(e.key)) || (e.altKey && e.key === 'Tab') || e.key === 'F12') {
                e.preventDefault(); handleWarning("This action is disabled during the exam.");
            }
        });
    }

    // --- LOGIN & INITIALIZATION ---
    async function handleProceed() {
        studentDetails.name = document.getElementById('student-name').value.trim();
        studentDetails.mobile = document.getElementById('student-mobile').value.trim();
        const examSelect = document.getElementById('exam-select');
        currentExam = allExams[examSelect.value];

        if (!studentDetails.name || !studentDetails.mobile) {
            return showToast("Please fill all details.", "warning");
        }
        
        const proceedBtn = document.getElementById('proceed-btn');
        proceedBtn.disabled = true;
        document.getElementById('proceed-btn-text').textContent = "Verifying...";
        document.getElementById('proceed-loading').style.display = "inline-block";
        
        try {
            const response = await fetch('/check-attempt', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mobile: studentDetails.mobile, quizId: currentExam.id })
            });
            const data = await response.json();
            
            if (data.success && data.canAttempt) {
                document.getElementById('login-form').innerHTML = `<h2>Exam Instructions</h2>
                    <p>This exam is AI-proctored. Do not switch tabs or exit full-screen.</p>
                    <p>Location and Camera access are mandatory.</p>
                    <button id="start-exam-btn" style="width:100%;">Grant Permissions & Start Exam</button>`;
                document.getElementById('start-exam-btn').onclick = requestLocationAndStart;
            } else {
                showToast(data.message || "You have already attempted this exam.", "warning");
            }
        } catch(e) {
            showToast('Could not verify attempt. Please check your connection.', "warning");
        } finally {
            proceedBtn.disabled = false;
            document.getElementById('proceed-btn-text').textContent = "Proceed";
            document.getElementById('proceed-loading').style.display = "none";
        }
    }

    async function loadInitialData() {
        try {
            const response = await fetch('/get-quizzes');
            allExams = await response.json();
            const selectContainer = document.getElementById('quiz-selection-container');
            let selectHTML = '<label for="exam-select">Select an Exam:</label><select id="exam-select">';
            allExams.forEach((exam, index) => selectHTML += `<option value="${index}">${exam.title}</option>`);
            selectHTML += '</select>';
            selectContainer.innerHTML = selectHTML;
            document.getElementById('proceed-btn').onclick = handleProceed;
        } catch (error) {
            document.body.innerHTML = "<h1>Error: Could not load exam data from server.</h1>";
        }
    }
    
    // --- EXAM ENGINE LOGIC ---
    function initializeExam() {
        examInProgress = true;
        document.getElementById('exam-title-main').textContent = currentExam.title;
        setupProctoring();
        setupProctoringListeners();

        Object.keys(currentExam.subjects).forEach(subject => { userResponses[subject] = {}; });
        currentSubject = Object.keys(currentExam.subjects)[0];
        currentQuestionIndex = 0;
        
        renderTabs();
        loadQuestion();
        startTimer(currentExam.timeLimit * 60);
    }
    
    function renderTabs() {
        const tabsContainer = document.querySelector('.subject-tabs');
        tabsContainer.innerHTML = '';
        Object.keys(currentExam.subjects).forEach(subject => {
            const tab = document.createElement('button');
            tab.className = 'subject-tab';
            if (subject === currentSubject) tab.classList.add('active');
            tab.textContent = subject;
            tab.onclick = () => switchSubject(subject);
            tabsContainer.appendChild(tab);
        });
    }

    function switchSubject(subject) {
        currentSubject = subject;
        currentQuestionIndex = 0;
        renderTabs();
        loadQuestion();
    }

    function loadQuestion() {
        const question = currentExam.subjects[currentSubject][currentQuestionIndex];
        const questionArea = document.getElementById('question-area');
        questionArea.innerHTML = `<h3>Question ${currentQuestionIndex + 1} of ${currentExam.subjects[currentSubject].length}</h3><p>${question.text}</p><div id="options-container"></div>`;
        const optionsContainer = document.getElementById('options-container');

        if (!userResponses[currentSubject][currentQuestionIndex]) {
            userResponses[currentSubject][currentQuestionIndex] = {};
        }
        const response = userResponses[currentSubject][currentQuestionIndex];

        if (question.type === "multiple-choice") {
            if (!response.shuffledOptions) {
                const originalCorrectAnswerObject = question.options[question.correctAnswer];
                const shuffledOptions = [...question.options].sort(() => Math.random() - 0.5);
                response.shuffledOptions = shuffledOptions;
                response.shuffledCorrectAnswerIndex = shuffledOptions.indexOf(originalCorrectAnswerObject);
            }
            response.shuffledOptions.forEach((optionObj, index) => {
                const div = document.createElement('div');
                div.className = 'option';
                div.textContent = optionObj.text; // Use optionObj.text
                if (response.answer === index) div.classList.add('selected');
                div.onclick = () => selectOption(index);
                optionsContainer.appendChild(div);
            });
        } else if (question.type === "fill-in-the-blank") {
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Enter your answer';
            input.value = response.answer || '';
            input.oninput = (e) => selectOption(e.target.value);
            optionsContainer.appendChild(input);
        }
        updatePalette();
    }
    
    function selectOption(answer) {
        const response = userResponses[currentSubject][currentQuestionIndex];
        response.answer = answer;
        response.status = 'answered';
        
        if (currentExam.subjects[currentSubject][currentQuestionIndex].type === "multiple-choice") {
            document.querySelectorAll('.option').forEach((opt, idx) => {
                opt.classList.toggle('selected', idx === answer);
            });
        }
        updatePalette();
    }

    function updatePalette() {
        const palette = document.getElementById('question-palette');
        palette.innerHTML = '';
        let globalQIndex = 0;
        Object.keys(currentExam.subjects).forEach(subject => {
            currentExam.subjects[subject].forEach((q, qIndex) => {
                const item = document.createElement('div');
                item.className = 'palette-item';
                item.textContent = globalQIndex + 1;
                const status = userResponses[subject]?.[qIndex]?.status || 'not-answered';
                item.classList.add(`status-${status}`);
                item.onclick = () => { currentSubject = subject; currentQuestionIndex = qIndex; renderTabs(); loadQuestion(); };
                palette.appendChild(item);
                globalQIndex++;
            });
        });
    }

    function startTimer(duration) {
        let timer = duration;
        const display = document.getElementById('timer');
        clearInterval(timerInterval); // Clear any existing timer
        timerInterval = setInterval(() => {
            if (!examInProgress) {
                clearInterval(timerInterval);
                return;
            }
            const hours = Math.floor(timer / 3600);
            const minutes = Math.floor((timer % 3600) / 60);
            const seconds = timer % 60;
            display.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            if (--timer < 0) {
                clearInterval(timerInterval);
                showToast("Time's up! Submitting your exam automatically.", 'warning');
                submitExam();
            }
        }, 1000);
    }

    function goNext() {
        if (currentQuestionIndex < currentExam.subjects[currentSubject].length - 1) {
            currentQuestionIndex++;
        } else {
            const subjectKeys = Object.keys(currentExam.subjects);
            const currentSubIndex = subjectKeys.indexOf(currentSubject);
            if (currentSubIndex < subjectKeys.length - 1) {
                switchSubject(subjectKeys[currentSubIndex + 1]);
            } else {
                showToast("You are at the last question.", "success");
            }
        }
        loadQuestion();
    }
    function saveAndNext() { goNext(); }
    
    function goPrevious() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
        } else {
            const subjectKeys = Object.keys(currentExam.subjects);
            const currentSubIndex = subjectKeys.indexOf(currentSubject);
            if (currentSubIndex > 0) {
                currentSubject = subjectKeys[currentSubIndex - 1];
                currentQuestionIndex = currentExam.subjects[currentSubject].length - 1;
                renderTabs();
            }
        }
        loadQuestion();
    }

    function clearResponse() {
        const response = userResponses[currentSubject]?.[currentQuestionIndex];
        if (response) { delete response.answer; delete response.status; }
        loadQuestion();
    }

    function markForReview() {
        userResponses[currentSubject][currentQuestionIndex].status = 'review';
        goNext();
    }
    
    function submitExam() {
        if (!examInProgress) return;
        examInProgress = false;
        clearInterval(timerInterval);
        
        let totalScore = 0;
        let subjectScores = {};
        Object.keys(currentExam.subjects).forEach(subject => {
            let currentSubjectScore = 0;
            currentExam.subjects[subject].forEach((q, index) => {
                const response = userResponses[subject]?.[index];
                if (response?.status !== 'answered') return;
                const marksCorrect = (currentExam.marksMode === 'custom' ? q.correctMarks : currentExam.correctMarks) ?? 1;
                const marksIncorrect = (currentExam.marksMode === 'custom' ? q.wrongMarks : currentExam.wrongMarks) ?? 0;
                if (q.type === 'multiple-choice') {
                    if (response.answer === response.shuffledCorrectAnswerIndex) currentSubjectScore += marksCorrect;
                    else currentSubjectScore += marksIncorrect;
                } else if (q.type === 'fill-in-the-blank') {
                    const correctAnswers = (q.answerKey || '').split('|').map(a => a.trim().toLowerCase());
                    const isCorrect = correctAnswers.includes(response.answer.toString().trim().toLowerCase());
                    currentSubjectScore += isCorrect ? marksCorrect : marksIncorrect;
                }
            });
            subjectScores[subject] = currentSubjectScore;
            totalScore += currentSubjectScore;
        });
        finalScores = { totalScore, subjectScores };
        const resultData = {
            studentName: studentDetails.name, mobile: studentDetails.mobile, location: studentDetails.location,
            quizId: currentExam.id, quizTitle: currentExam.title,
            totalScore, subjectScores, warnings: warningCount, responses: userResponses,
            date: new Date().toISOString()
        };
        fetch('/submit-result', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(resultData)
        }).then(res => {
            if (!res.ok) throw new Error('Submission failed');
            document.getElementById('exam-screen').innerHTML = `<div style="text-align:center; margin: 50px auto;">
                <h1>Thank You!</h1><p>Your exam has been submitted successfully.</p>
                <button onclick="downloadStudentReport()">Download Your Report</button>
            </div>`;
        }).catch(err => { alert('Submission failed. Please check your connection and contact support.'); });
    }

    function confirmSubmit() {
        if (confirm("Are you sure you want to submit the exam?")) {
            submitExam();
        }
    }
    
  async function downloadStudentReport() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 20;

        // Calculate total possible score for the exam
        let totalMaxScore = 0;
        if (currentExam && currentExam.subjects) {
            Object.values(currentExam.subjects).forEach(subjectQuestions => {
                subjectQuestions.forEach(q => {
                    totalMaxScore += Number((currentExam.marksMode === 'custom' ? q.correctMarks : currentExam.correctMarks) || 1);
                });
            });
        }
        if (totalMaxScore === 0) totalMaxScore = 100; // Fallback


        const colors = { primary: '#0056b3', text: '#333', bg: '#f8f9fa', success: '#28a745', danger: '#dc3545' };

        // --- HEADER ---
        doc.setFillColor(colors.primary);
        doc.rect(0, 0, 210, 30, 'F');
        if (GEETHAM_LOGO_BASE64 && GEETHAM_LOGO_BASE64.startsWith('data:image')) {
            doc.addImage('geetham.jpg', 'JPEG', 15, 5, 20, 20);
        }
        doc.setFontSize(22);
        doc.setTextColor('#FFFFFF');
        doc.setFont(undefined, 'bold');
        doc.text('Geetham e-Exam Report', 105, 18, { align: 'center' });
        y = 45;
        
        // --- STUDENT DETAILS ---
        doc.setFontSize(12);
        doc.setTextColor(colors.text);
        doc.setFont(undefined, 'bold');
        doc.text('Student Name:', 15, y);
        doc.setFont(undefined, 'normal');
        doc.text(studentDetails.name, 50, y);
        y += 7;
        doc.setFont(undefined, 'bold');
        doc.text('Mobile:', 15, y);
        doc.setFont(undefined, 'normal');
        doc.text(studentDetails.mobile, 50, y);
        y += 10;

        doc.setFont(undefined, 'bold');
        doc.text('Exam Title:', 15, y);
        doc.setFont(undefined, 'normal');
        doc.text(currentExam.title, 50, y);
        y += 7;
        doc.setFont(undefined, 'bold');
        doc.text('Date:', 15, y);
        doc.setFont(undefined, 'normal');
        doc.text(new Date().toLocaleDateString(), 50, y);
        y += 15;

        // --- PERFORMANCE SUMMARY ---
        doc.setFontSize(16);
        doc.setTextColor(colors.primary);
        doc.setFont(undefined, 'bold');
        doc.text('Performance Summary', 15, y);
        y += 10;
        doc.setLineWidth(0.5);
        doc.line(15, y - 5, 195, y - 5);
        
        doc.setFontSize(12);
        doc.setTextColor(colors.text);
        doc.text(`Final Score:`, 15, y);
        const scorePercentage = (finalScores.totalScore / totalMaxScore) * 100;
        doc.setFont(undefined, 'bold');
        doc.setTextColor(scorePercentage >= 40 ? colors.success : colors.danger);
        doc.text(`${finalScores.totalScore.toFixed(2)} / ${totalMaxScore.toFixed(2)} (${scorePercentage.toFixed(1)}%)`, 60, y);
        y += 8;

        doc.setFont(undefined, 'normal');
        doc.setTextColor(colors.text);
        doc.text(`Proctoring Warnings:`, 15, y);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(warningCount > 0 ? colors.danger : colors.success);
        doc.text(`${warningCount}`, 60, y);
        y += 15;
        
        // --- SUBJECT BREAKDOWN ---
        doc.setFontSize(14);
        doc.setTextColor(colors.primary);
        doc.setFont(undefined, 'bold');
        doc.text('Subject Score Breakdown', 15, y);
        y += 8;

        Object.entries(finalScores.subjectScores).forEach(([subject, score]) => {
            doc.setFontSize(12);
            doc.setTextColor(colors.text);
            doc.setFont(undefined, 'normal');
            doc.text(`${subject}:`, 20, y);
            doc.setFont(undefined, 'bold');
            doc.text(score.toFixed(2), 70, y);
            y += 7;
        });

        doc.save(`${studentDetails.name}_Exam_Report.pdf`);
    }
    
    Object.assign(window, { markForReview, goPrevious, clearResponse, saveAndNext, confirmSubmit, downloadStudentReport });
    loadInitialData();
</script>
</body>
</html>
